@model ACETreasureHunt.Models.PitStop

@{
    ViewBag.Title = "Create";
}

<h2>Create</h2>


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>PitStop</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="form-group">
            @Html.LabelFor(model => model.PitStopName, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.PitStopName, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.PitStopName, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Description, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Description, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.PitStopNumber, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.PitStopNumber, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.PitStopNumber, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Latitude, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Latitude, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Latitude, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Longitude, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Longitude, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Longitude, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.EventID, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.EventID, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.EventID, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Create" class="btn btn-default" />
            </div>
        </div>
    </div>



    <div id="map" data-mode="" style=" height: 480px; width: 500px ">
        <input type="hidden" data-map-markers="" value="" name="map-geojson-data" />
    </div>
    <div>
        <input id="btnGetLocation" class="btn btn-primary btn-lg btn3d" type="button" value="Save Pit-Stop" />
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        $(document).ready(function () {

            var osmUrl = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
                osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                osm = L.tileLayer(osmUrl, {
                    maxZoom: 18,
                    attribution: osmAttrib
                });


            var map = L.map('map').setView([25.92, 79.84], 5).addLayer(osm);


            map.on('click', onMapClick);


            function onMapClick(e) {

                var geojsonFeature = {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "type": "Point",
                        "coordinates": [e.latlng.lat, e.latlng.lng]
                    }
                }

                var marker;

                L.geoJson(geojsonFeature, {

                    pointToLayer: function (feature, latlng) {

                        marker = L.marker(e.latlng, {

                            title: "Resource Location",
                            alt: "Resource Location",
                            riseOnHover: true,
                            draggable: true,

                        }).bindPopup("<input type='button' value='Remove this' class='marker-delete-button'/>");

                        marker.on("popupopen", onPopupOpen);

                        return marker;
                    }
                }).addTo(map);
            }

            function onPopupOpen() {

                var tempMarker = this;

                //var tempMarkerGeoJSON = this.toGeoJSON();
                //var lID = tempMarker._leaflet_id; // Getting Leaflet ID of this marker

                $(".marker-delete-button:visible").click(function () {
                    map.removeLayer(tempMarker);
                });
            }

            function getAllMarkers() {

                var allMarkersObjArray = [];
                var allMarkersGeoJsonArray = [];

                $.each(map._layers, function (ml) {
                    //console.log(map._layers)
                    if (map._layers[ml].feature) {

                        allMarkersObjArray.push(this)
                        allMarkersGeoJsonArray.push(JSON.stringify(this.toGeoJSON()))
                    }
                })



                if (allMarkersGeoJsonArray.length == 0) {
                    alert("Please select a PitStop Location on the Map");
                } else if (allMarkersGeoJsonArray.length > 1) {
                    alert("Please select single location for this PitStop");
                } else {
                    //alert(allMarkersGeoJsonArray);
                    //alert(JSON.parse(allMarkersGeoJsonArray).geometry.coordinates);
                    //alert(JSON.parse(allMarkersGeoJsonArray).geometry.coordinates[0]);

                    $('#Latitude').val(JSON.parse(allMarkersGeoJsonArray).geometry.coordinates[1].toFixed(4));
                    $('#Longitude').val(JSON.parse(allMarkersGeoJsonArray).geometry.coordinates[0].toFixed(4));

                }

                // console.log(allMarkersObjArray);
                //alert("total Markers : " + allMarkersGeoJsonArray.length + "\n\n" + allMarkersGeoJsonArray + "\n\n Also see your console for object view of this array");
            }

            $("#btnGetLocation").on("click", getAllMarkers);


        });


    </script>
}

@*'pk.eyJ1IjoiZ3VydXByYWJhIiwiYSI6ImNqMXZtMnAwYTAwMGEyd3BlZDN6b2UyYXQifQ.TLQvP6CeBZLbEWrtmu7fIw'*@
